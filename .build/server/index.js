"use strict";

require("source-map-support/register");

var _server = require("@soundworks/core/server");

var _path = _interopRequireDefault(require("path"));

var _serveStatic = _interopRequireDefault(require("serve-static"));

var _templateLiteral = _interopRequireDefault(require("template-literal"));

var _stateManagerOsc = require("@soundworks/state-manager-osc");

var _score = _interopRequireDefault(require("./schemas/score.js"));

var _player = _interopRequireDefault(require("./schemas/player.js"));

var _busControls = _interopRequireDefault(require("./schemas/busControls.js"));

var _server2 = _interopRequireDefault(require("@soundworks/plugin-platform/server"));

var _server3 = _interopRequireDefault(require("@soundworks/plugin-sync/server"));

var _server4 = _interopRequireDefault(require("@soundworks/plugin-checkin/server"));

var _PlayerExperience = _interopRequireDefault(require("./PlayerExperience.js"));

var _ControllerExperience = _interopRequireDefault(require("./ControllerExperience.js"));

var _getConfig = _interopRequireDefault(require("../utils/getConfig.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const ENV = process.env.ENV || 'default';
const config = (0, _getConfig.default)(ENV);
const server = new _server.Server(); // html template and static files (in most case, this should not be modified)

server.templateEngine = {
  compile: _templateLiteral.default
};
server.templateDirectory = _path.default.join('.build', 'server', 'tmpl');
server.router.use((0, _serveStatic.default)('public'));
server.router.use('build', (0, _serveStatic.default)(_path.default.join('.build', 'public')));
server.router.use('vendors', (0, _serveStatic.default)(_path.default.join('.vendors', 'public')));
console.log(`
--------------------------------------------------------
- launching "${config.app.name}" in "${ENV}" environment
- [pid: ${process.pid}]
--------------------------------------------------------
`); // -------------------------------------------------------------------
// register plugins
// -------------------------------------------------------------------
// server.pluginManager.register(pluginName, pluginFactory, [pluginOptions], [dependencies])

server.pluginManager.register('platform', _server2.default, {}, []);
server.pluginManager.register('sync', _server3.default, {}, []);
server.pluginManager.register('checkin', _server4.default, {}, []); // -------------------------------------------------------------------
// register schemas
// -------------------------------------------------------------------
// server.stateManager.registerSchema(name, schema);

server.stateManager.registerSchema('score', _score.default);
server.stateManager.registerSchema('player', _player.default);
server.stateManager.registerSchema('globalBusControls', _busControls.default);
server.stateManager.registerSchema('sineBusControls', _busControls.default);
server.stateManager.registerSchema('amBusControls', _busControls.default);
server.stateManager.registerSchema('fmBusControls', _busControls.default);

(async function launch() {
  try {
    await server.init(config, (clientType, config, httpRequest) => {
      return {
        clientType: clientType,
        app: {
          name: config.app.name,
          author: config.app.author
        },
        env: {
          type: config.env.type,
          websockets: config.env.websockets,
          subpath: config.env.subpath
        }
      };
    });
    const sync = server.pluginManager.get('sync');
    const score = await server.stateManager.create('score');
    const globalMasterControls = await server.stateManager.create('globalBusControls');
    const sineMasterControls = await server.stateManager.create('sineBusControls');
    const amMasterControls = await server.stateManager.create('amBusControls');
    const fmMasterControls = await server.stateManager.create('fmBusControls');
    const playerExperience = new _PlayerExperience.default(server, 'player');
    const controllerExperience = new _ControllerExperience.default(server, 'controller'); // start all the things

    await server.start();
    playerExperience.start();
    controllerExperience.start();
    const oscConfig = {
      // these are the defaults
      localAddress: '0.0.0.0',
      localPort: 57121,
      remoteAddress: '127.0.0.1',
      remotePort: 57122
    };
    const oscStateManager = new _stateManagerOsc.StateManagerOsc(server.stateManager, oscConfig);
    await oscStateManager.init(); //Observe players connections

    const players = new Set();
    const playersIds = new Array();
    server.stateManager.observe(async (schemaName, stateId, nodeId) => {
      switch (schemaName) {
        case 'player':
          const playerState = await server.stateManager.attach(schemaName, stateId);
          const plId = server.stateManager.get('id');
          playerState.onDetach(() => {
            // clean things
            players.delete(playerState);
            playersIds.splice(playersIds.indexOf(plId), 1);
          });
          players.add(playerState);
          playersIds.add(plId);
          break;
      }
    }); //Receiving notes from Max by OSC

    score.subscribe(async updates => {
      if (updates.hasOwnProperty('notes')) {
        // console.log("note received", updates.notes.length);
        const dispatchStrategy = score.get('dispatchStrategy');

        switch (dispatchStrategy) {
          case 'sendAll':
            players.forEach(playerState => {
              playerState.set({
                note: updates.notes,
                playTime: sync.getSyncTime() + 0.1
              });
            });
            break;

          case 'randomSpread':
            const nNotes = updates.notes.length;
            const nPlayers = playersIds.length;
            const assignment = randomGrouping(nNotes, nPlayers);
            players.forEach(playerState => {
              const plId = playerState.get('id');
              const idIdx = playersIds.indexOf(plId);
              const plAssignment = assignment[idIdx];
              const notesToSend = [];

              for (let n of plAssignment) {
                notesToSend.push(updates.notes[n]);
              }

              playerState.set({
                note: notesToSend,
                playTime: sync.getSyncTime() + 0.1
              });
            });
            break;
        }
      }
    });
  } catch (err) {
    console.error(err.stack);
  }
})();

function randomGrouping(nGroups, nPlayers) {
  const assignment = Array.from(new Array(nPlayers), () => []);

  if (nGroups <= nPlayers) {
    const players = Array.from(Array(nPlayers).keys());
    let gp = 0;

    while (players.length > nPlayers % nGroups) {
      const randomIdx = Math.floor(Math.random() * players.length);
      const player = players[randomIdx];
      assignment[player].push(gp);
      players.splice(randomIdx, 1);
      gp = (gp + 1) % nGroups;
    }

    const groups = Array.from(Array(nGroups).keys());

    while (players.length > 0) {
      const randomIdxPl = Math.floor(Math.random() * players.length);
      const randomIdxGp = Math.floor(Math.random() * groups.length);
      const player = players[randomIdxPl];
      const group = groups[randomIdxGp];
      assignment[player].push(group);
      players.splice(randomIdxPl, 1);
      groups.splice(randomIdxGp, 1);
    }
  } else {
    const groups = Array.from(Array(nGroups).keys());
    let pl = 0;

    while (groups.length > nGroups % nPlayers) {
      const randomIdx = Math.floor(Math.random() * groups.length);
      const group = groups[randomIdx];
      assignment[pl].push(group);
      groups.splice(randomIdx, 1);
      pl = (pl + 1) % nPlayers;
      console.log(assignment);
    }

    console.log('second part');
    const players = Array.from(Array(nPlayers).keys());

    while (groups.length > 0) {
      const randomIdxPl = Math.floor(Math.random() * players.length);
      const randomIdxGp = Math.floor(Math.random() * groups.length);
      const player = players[randomIdxPl];
      const group = groups[randomIdxGp];
      assignment[player].push(group);
      players.splice(randomIdxPl, 1);
      groups.splice(randomIdxGp, 1);
      console.log(assignment);
    }
  }

  return assignment;
}

process.on('unhandledRejection', (reason, p) => {
  console.log('> Unhandled Promise Rejection');
  console.log(reason);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIkVOViIsInByb2Nlc3MiLCJlbnYiLCJjb25maWciLCJzZXJ2ZXIiLCJTZXJ2ZXIiLCJ0ZW1wbGF0ZUVuZ2luZSIsImNvbXBpbGUiLCJ0ZW1wbGF0ZURpcmVjdG9yeSIsInBhdGgiLCJqb2luIiwicm91dGVyIiwidXNlIiwiY29uc29sZSIsImxvZyIsImFwcCIsIm5hbWUiLCJwaWQiLCJwbHVnaW5NYW5hZ2VyIiwicmVnaXN0ZXIiLCJwbHVnaW5QbGF0Zm9ybUZhY3RvcnkiLCJwbHVnaW5TeW5jRmFjdG9yeSIsInBsdWdpbkNoZWNraW5GYWN0b3J5Iiwic3RhdGVNYW5hZ2VyIiwicmVnaXN0ZXJTY2hlbWEiLCJzY29yZVNjaGVtYSIsInBsYXllclNjaGVtYSIsImJ1c0NvbnRyb2xzU2NoZW1hIiwibGF1bmNoIiwiaW5pdCIsImNsaWVudFR5cGUiLCJodHRwUmVxdWVzdCIsImF1dGhvciIsInR5cGUiLCJ3ZWJzb2NrZXRzIiwic3VicGF0aCIsInN5bmMiLCJnZXQiLCJzY29yZSIsImNyZWF0ZSIsImdsb2JhbE1hc3RlckNvbnRyb2xzIiwic2luZU1hc3RlckNvbnRyb2xzIiwiYW1NYXN0ZXJDb250cm9scyIsImZtTWFzdGVyQ29udHJvbHMiLCJwbGF5ZXJFeHBlcmllbmNlIiwiUGxheWVyRXhwZXJpZW5jZSIsImNvbnRyb2xsZXJFeHBlcmllbmNlIiwiQ29udHJvbGxlckV4cGVyaWVuY2UiLCJzdGFydCIsIm9zY0NvbmZpZyIsImxvY2FsQWRkcmVzcyIsImxvY2FsUG9ydCIsInJlbW90ZUFkZHJlc3MiLCJyZW1vdGVQb3J0Iiwib3NjU3RhdGVNYW5hZ2VyIiwiU3RhdGVNYW5hZ2VyT3NjIiwicGxheWVycyIsIlNldCIsInBsYXllcnNJZHMiLCJBcnJheSIsIm9ic2VydmUiLCJzY2hlbWFOYW1lIiwic3RhdGVJZCIsIm5vZGVJZCIsInBsYXllclN0YXRlIiwiYXR0YWNoIiwicGxJZCIsIm9uRGV0YWNoIiwiZGVsZXRlIiwic3BsaWNlIiwiaW5kZXhPZiIsImFkZCIsInN1YnNjcmliZSIsInVwZGF0ZXMiLCJoYXNPd25Qcm9wZXJ0eSIsImRpc3BhdGNoU3RyYXRlZ3kiLCJmb3JFYWNoIiwic2V0Iiwibm90ZSIsIm5vdGVzIiwicGxheVRpbWUiLCJnZXRTeW5jVGltZSIsIm5Ob3RlcyIsImxlbmd0aCIsIm5QbGF5ZXJzIiwiYXNzaWdubWVudCIsInJhbmRvbUdyb3VwaW5nIiwiaWRJZHgiLCJwbEFzc2lnbm1lbnQiLCJub3Rlc1RvU2VuZCIsIm4iLCJwdXNoIiwiZXJyIiwiZXJyb3IiLCJzdGFjayIsIm5Hcm91cHMiLCJmcm9tIiwia2V5cyIsImdwIiwicmFuZG9tSWR4IiwiTWF0aCIsImZsb29yIiwicmFuZG9tIiwicGxheWVyIiwiZ3JvdXBzIiwicmFuZG9tSWR4UGwiLCJyYW5kb21JZHhHcCIsImdyb3VwIiwicGwiLCJvbiIsInJlYXNvbiIsInAiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7Ozs7QUFFQSxNQUFNQSxHQUFHLEdBQUdDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRixHQUFaLElBQW1CLFNBQS9CO0FBQ0EsTUFBTUcsTUFBTSxHQUFHLHdCQUFVSCxHQUFWLENBQWY7QUFDQSxNQUFNSSxNQUFNLEdBQUcsSUFBSUMsY0FBSixFQUFmLEMsQ0FFQTs7QUFDQUQsTUFBTSxDQUFDRSxjQUFQLEdBQXdCO0FBQUVDLEVBQUFBLE9BQU8sRUFBUEE7QUFBRixDQUF4QjtBQUNBSCxNQUFNLENBQUNJLGlCQUFQLEdBQTJCQyxjQUFLQyxJQUFMLENBQVUsUUFBVixFQUFvQixRQUFwQixFQUE4QixNQUE5QixDQUEzQjtBQUNBTixNQUFNLENBQUNPLE1BQVAsQ0FBY0MsR0FBZCxDQUFrQiwwQkFBWSxRQUFaLENBQWxCO0FBQ0FSLE1BQU0sQ0FBQ08sTUFBUCxDQUFjQyxHQUFkLENBQWtCLE9B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QVcsR0FBR0wsSUFBSSxDQUFDQyxLQUFMLENBQVdELElBQUksQ0FBQ0UsTUFBTCxLQUFnQjlDLE9BQU8sQ0FBQzJCLE1BQW5DLENBQXBCO0FBQ0EsWUFBTXVCLFdBQVcsR0FBR04sSUFBSSxDQUFDQyxLQUFMLENBQVdELElBQUksQ0FBQ0UsTUFBTCxLQUFnQkUsTUFBTSxDQUFDckIsTUFBbEMsQ0FBcEI7QUFDQSxZQUFNb0IsTUFBTSxHQUFHL0MsT0FBTyxDQUFDaUQsV0FBRCxDQUF0QjtBQUNBLFlBQU1FLEtBQUssR0FBR0gsTUFBTSxDQUFDRSxXQUFELENBQXBCO0FBQ0FyQixNQUFBQSxVQUFVLENBQUNrQixNQUFELENBQVYsQ0FBbUJaLElBQW5CLENBQXdCZ0IsS0FBeEI7QUFDQW5ELE1BQUFBLE9BQU8sQ0FBQ2EsTUFBUixDQUFlb0MsV0FBZixFQUE0QixDQUE1QjtBQUNBRCxNQUFBQSxNQUFNLENBQUNuQyxNQUFQLENBQWNxQyxXQUFkLEVBQTJCLENBQTNCO0FBQ0E3RixNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWXVFLFVBQVo7QUFDRDtBQUNGOztBQUNELFNBQU9BLFVBQVA7QUFDRDs7QUFFRHBGLE9BQU8sQ0FBQzRHLEVBQVIsQ0FBVyxvQkFBWCxFQUFpQyxDQUFDQyxNQUFELEVBQVNDLENBQVQsS0FBZTtBQUM5Q2xHLEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLCtCQUFaO0FBQ0FELEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZZ0csTUFBWjtBQUNELENBSEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ3NvdXJjZS1tYXAtc3VwcG9ydC9yZWdpc3Rlcic7XG5pbXBvcnQgeyBTZXJ2ZXIgfSBmcm9tICdAc291bmR3b3Jrcy9jb3JlL3NlcnZlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBzZXJ2ZVN0YXRpYyBmcm9tICdzZXJ2ZS1zdGF0aWMnO1xuaW1wb3J0IGNvbXBpbGUgZnJvbSAndGVtcGxhdGUtbGl0ZXJhbCc7XG5cbmltcG9ydCB7IFN0YXRlTWFuYWdlck9zYyB9IGZyb20gJ0Bzb3VuZHdvcmtzL3N0YXRlLW1hbmFnZXItb3NjJztcblxuaW1wb3J0IHNjb3JlU2NoZW1hIGZyb20gJy4vc2NoZW1hcy9zY29yZS5qcyc7XG5pbXBvcnQgcGxheWVyU2NoZW1hIGZyb20gJy4vc2NoZW1hcy9wbGF5ZXIuanMnO1xuaW1wb3J0IGJ1c0NvbnRyb2xzU2NoZW1hIGZyb20gJy4vc2NoZW1hcy9idXNDb250cm9scy5qcyc7XG5cbmltcG9ydCBwbHVnaW5QbGF0Zm9ybUZhY3RvcnkgZnJvbSAnQHNvdW5kd29ya3MvcGx1Z2luLXBsYXRmb3JtL3NlcnZlcic7XG5pbXBvcnQgcGx1Z2luU3luY0ZhY3RvcnkgZnJvbSAnQHNvdW5kd29ya3MvcGx1Z2luLXN5bmMvc2VydmVyJztcbmltcG9ydCBwbHVnaW5DaGVja2luRmFjdG9yeSBmcm9tICdAc291bmR3b3Jrcy9wbHVnaW4tY2hlY2tpbi9zZXJ2ZXInO1xuXG5pbXBvcnQgUGxheWVyRXhwZXJpZW5jZSBmcm9tICcuL1BsYXllckV4cGVyaWVuY2UuanMnO1xuaW1wb3J0IENvbnRyb2xsZXJFeHBlcmllbmNlIGZyb20gJy4vQ29udHJvbGxlckV4cGVyaWVuY2UuanMnO1xuXG5pbXBvcnQgZ2V0Q29uZmlnIGZyb20gJy4uL3V0aWxzL2dldENvbmZpZy5qcyc7XG5pbXBvcnQgcGxheWVyIGZyb20gJy4vc2NoZW1hcy9wbGF5ZXIuanMnO1xuY29uc3QgRU5WID0gcHJvY2Vzcy5lbnYuRU5WIHx8ICdkZWZhdWx0JztcbmNvbnN0IGNvbmZpZyA9IGdldENvbmZpZyhFTlYpO1xuY29uc3Qgc2VydmVyID0gbmV3IFNlcnZlcigpO1xuXG4vLyBodG1sIHRlbXBsYXRlIGFuZCBzdGF0aWMgZmlsZXMgKGluIG1vc3QgY2FzZSwgdGhpcyBzaG91bGQgbm90IGJlIG1vZGlmaWVkKVxuc2VydmVyLnRlbXBsYXRlRW5naW5lID0geyBjb21waWxlIH07XG5zZXJ2ZXIudGVtcGxhdGVEaXJlY3RvcnkgPSBwYXRoLmpvaW4oJy5idWlsZCcsICdzZXJ2ZXInLCAndG1wbCcpO1xuc2VydmVyLnJvdXRlci51c2Uoc2VydmVTdGF0aWMoJ3B1YmxpYycpKTtcbnNlcnZlci5yb3V0ZXIudXNlKCdidWlsZCcsIHNlcnZlU3RhdGljKHBhdGguam9pbignLmJ1aWxkJywgJ3B1YmxpYycpKSk7XG5zZXJ2ZXIucm91dGVyLnVzZSgndmVuZG9ycycsIHNlcnZlU3RhdGljKHBhdGguam9pbignLnZlbmRvcnMnLCAncHVibGljJykpKTtcblxuY29uc29sZS5sb2coYFxuLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi0gbGF1bmNoaW5nIFwiJHtjb25maWcuYXBwLm5hbWV9XCIgaW4gXCIke0VOVn1cIiBlbnZpcm9ubWVudFxuLSBbcGlkOiAke3Byb2Nlc3MucGlkfV1cbi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5gKTtcblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gcmVnaXN0ZXIgcGx1Z2luc1xuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gc2VydmVyLnBsdWdpbk1hbmFnZXIucmVnaXN0ZXIocGx1Z2luTmFtZSwgcGx1Z2luRmFjdG9yeSwgW3BsdWdpbk9wdGlvbnNdLCBbZGVwZW5kZW5jaWVzXSlcbnNlcnZlci5wbHVnaW5NYW5hZ2VyLnJlZ2lzdGVyKCdwbGF0Zm9ybScsIHBsdWdpblBsYXRmb3JtRmFjdG9yeSwge30sIFtdKTtcbnNlcnZlci5wbHVnaW5NYW5hZ2VyLnJlZ2lzdGVyKCdzeW5jJywgcGx1Z2luU3luY0ZhY3RvcnksIHt9LCBbXSk7XG5zZXJ2ZXIucGx1Z2luTWFuYWdlci5yZWdpc3RlcignY2hlY2tpbicsIHBsdWdpbkNoZWNraW5GYWN0b3J5LCB7fSwgW10pO1xuXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4vLyByZWdpc3RlciBzY2hlbWFzXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4vLyBzZXJ2ZXIuc3RhdGVNYW5hZ2VyLnJlZ2lzdGVyU2NoZW1hKG5hbWUsIHNjaGVtYSk7XG5zZXJ2ZXIuc3RhdGVNYW5hZ2VyLnJlZ2lzdGVyU2NoZW1hKCdzY29yZScsIHNjb3JlU2NoZW1hKTtcbnNlcnZlci5zdGF0ZU1hbmFnZXIucmVnaXN0ZXJTY2hlbWEoJ3BsYXllcicsIHBsYXllclNjaGVtYSk7XG5zZXJ2ZXIuc3RhdGVNYW5hZ2VyLnJlZ2lzdGVyU2NoZW1hKCdnbG9iYWxCdXNDb250cm9scycsIGJ1c0NvbnRyb2xzU2NoZW1hKTtcbnNlcnZlci5zdGF0ZU1hbmFnZXIucmVnaXN0ZXJTY2hlbWEoJ3NpbmVCdXNDb250cm9scycsIGJ1c0NvbnRyb2xzU2NoZW1hKTtcbnNlcnZlci5zdGF0ZU1hbmFnZXIucmVnaXN0ZXJTY2hlbWEoJ2FtQnVzQ29udHJvbHMnLCBidXNDb250cm9sc1NjaGVtYSk7XG5zZXJ2ZXIuc3RhdGVNYW5hZ2VyLnJlZ2lzdGVyU2NoZW1hKCdmbUJ1c0NvbnRyb2xzJywgYnVzQ29udHJvbHNTY2hlbWEpO1xuXG5cbihhc3luYyBmdW5jdGlvbiBsYXVuY2goKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgc2VydmVyLmluaXQoY29uZmlnLCAoY2xpZW50VHlwZSwgY29uZmlnLCBodHRwUmVxdWVzdCkgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgY2xpZW50VHlwZTogY2xpZW50VHlwZSxcbiAgICAgICAgYXBwOiB7XG4gICAgICAgICAgbmFtZTogY29uZmlnLmFwcC5uYW1lLFxuICAgICAgICAgIGF1dGhvcjogY29uZmlnLmFwcC5hdXRob3IsXG4gICAgICAgIH0sXG4gICAgICAgIGVudjoge1xuICAgICAgICAgIHR5cGU6IGNvbmZpZy5lbnYudHlwZSxcbiAgICAgICAgICB3ZWJzb2NrZXRzOiBjb25maWcuZW52LndlYnNvY2tldHMsXG4gICAgICAgICAgc3VicGF0aDogY29uZmlnLmVudi5zdWJwYXRoLFxuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0pO1xuXG4gICAgY29uc3Qgc3luYyA9IHNlcnZlci5wbHVnaW5NYW5hZ2VyLmdldCgnc3luYycpO1xuXG4gICAgY29uc3Qgc2NvcmUgPSBhd2FpdCBzZXJ2ZXIuc3RhdGVNYW5hZ2VyLmNyZWF0ZSgnc2NvcmUnKTtcbiAgICBjb25zdCBnbG9iYWxNYXN0ZXJDb250cm9scyA9IGF3YWl0IHNlcnZlci5zdGF0ZU1hbmFnZXIuY3JlYXRlKCdnbG9iYWxCdXNDb250cm9scycpO1xuICAgIGNvbnN0IHNpbmVNYXN0ZXJDb250cm9scyA9IGF3YWl0IHNlcnZlci5zdGF0ZU1hbmFnZXIuY3JlYXRlKCdzaW5lQnVzQ29udHJvbHMnKTtcbiAgICBjb25zdCBhbU1hc3RlckNvbnRyb2xzID0gYXdhaXQgc2VydmVyLnN0YXRlTWFuYWdlci5jcmVhdGUoJ2FtQnVzQ29udHJvbHMnKTtcbiAgICBjb25zdCBmbU1hc3RlckNvbnRyb2xzID0gYXdhaXQgc2VydmVyLnN0YXRlTWFuYWdlci5jcmVhdGUoJ2ZtQnVzQ29udHJvbHMnKTtcblxuICAgIGNvbnN0IHBsYXllckV4cGVyaWVuY2UgPSBuZXcgUGxheWVyRXhwZXJpZW5jZShzZXJ2ZXIsICdwbGF5ZXInKTtcbiAgICBjb25zdCBjb250cm9sbGVyRXhwZXJpZW5jZSA9IG5ldyBDb250cm9sbGVyRXhwZXJpZW5jZShzZXJ2ZXIsICdjb250cm9sbGVyJyk7XG5cbiAgICAvLyBzdGFydCBhbGwgdGhlIHRoaW5nc1xuICAgIGF3YWl0IHNlcnZlci5zdGFydCgpO1xuICAgIHBsYXllckV4cGVyaWVuY2Uuc3RhcnQoKTtcbiAgICBjb250cm9sbGVyRXhwZXJpZW5jZS5zdGFydCgpO1xuXG4gICAgY29uc3Qgb3NjQ29uZmlnID0geyAvLyB0aGVzZSBhcmUgdGhlIGRlZmF1bHRzXG4gICAgICBsb2NhbEFkZHJlc3M6ICcwLjAuMC4wJyxcbiAgICAgIGxvY2FsUG9ydDogNTcxMjEsXG4gICAgICByZW1vdGVBZGRyZXNzOiAnMTI3LjAuMC4xJyxcbiAgICAgIHJlbW90ZVBvcnQ6IDU3MTIyLFxuICAgIH07XG4gICAgXG4gICAgY29uc3Qgb3NjU3RhdGVNYW5hZ2VyID0gbmV3IFN0YXRlTWFuYWdlck9zYyhzZXJ2ZXIuc3RhdGVNYW5hZ2VyLCBvc2NDb25maWcpO1xuICAgIGF3YWl0IG9zY1N0YXRlTWFuYWdlci5pbml0KCk7XG5cbiAgICAvL09ic2VydmUgcGxheWVycyBjb25uZWN0aW9uc1xuICAgIGNvbnN0IHBsYXllcnMgPSBuZXcgU2V0KCk7XG4gICAgY29uc3QgcGxheWVyc0lkcyA9IG5ldyBBcnJheSgpO1xuXG4gICAgc2VydmVyLnN0YXRlTWFuYWdlci5vYnNlcnZlKGFzeW5jIChzY2hlbWFOYW1lLCBzdGF0ZUlkLCBub2RlSWQpID0+IHtcbiAgICAgIHN3aXRjaCAoc2NoZW1hTmFtZSkge1xuICAgICAgICBjYXNlICdwbGF5ZXInOlxuICAgICAgICAgIGNvbnN0IHBsYXllclN0YXRlID0gYXdhaXQgc2VydmVyLnN0YXRlTWFuYWdlci5hdHRhY2goc2NoZW1hTmFtZSwgc3RhdGVJZCk7XG4gICAgICAgICAgY29uc3QgcGxJZCA9IHNlcnZlci5zdGF0ZU1hbmFnZXIuZ2V0KCdpZCcpO1xuICAgICAgICAgIHBsYXllclN0YXRlLm9uRGV0YWNoKCgpID0+IHtcbiAgICAgICAgICAgIC8vIGNsZWFuIHRoaW5nc1xuICAgICAgICAgICAgcGxheWVycy5kZWxldGUocGxheWVyU3RhdGUpO1xuICAgICAgICAgICAgcGxheWVyc0lkcy5zcGxpY2UocGxheWVyc0lkcy5pbmRleE9mKHBsSWQpLCAxKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBwbGF5ZXJzLmFkZChwbGF5ZXJTdGF0ZSk7XG4gICAgICAgICAgcGxheWVyc0lkcy5hZGQocGxJZCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfSk7XG5cblxuICAgIC8vUmVjZWl2aW5nIG5vdGVzIGZyb20gTWF4IGJ5IE9TQ1xuICAgIHNjb3JlLnN1YnNjcmliZShhc3luYyB1cGRhdGVzID0+IHtcbiAgICAgIGlmICh1cGRhdGVzLmhhc093blByb3BlcnR5KCdub3RlcycpKSB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwibm90ZSByZWNlaXZlZFwiLCB1cGRhdGVzLm5vdGVzLmxlbmd0aCk7XG4gICAgICAgIGNvbnN0IGRpc3BhdGNoU3RyYXRlZ3kgPSBzY29yZS5nZXQoJ2Rpc3BhdGNoU3RyYXRlZ3knKTtcbiAgICAgICAgXG4gICAgICAgIHN3aXRjaCAoZGlzcGF0Y2hTdHJhdGVneSkge1xuICAgICAgICAgIGNhc2UgJ3NlbmRBbGwnOlxuICAgICAgICAgICAgcGxheWVycy5mb3JFYWNoKHBsYXllclN0YXRlID0+IHtcbiAgICAgICAgICAgICAgcGxheWVyU3RhdGUuc2V0KHsgbm90ZTogdXBkYXRlcy5ub3RlcywgcGxheVRpbWU6IHN5bmMuZ2V0U3luY1RpbWUoKSArIDAuMSB9KTtcbiAgICAgICAgICAgIH0pOyAgICBcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ3JhbmRvbVNwcmVhZCc6XG4gICAgICAgICAgICBjb25zdCBuTm90ZXMgPSB1cGRhdGVzLm5vdGVzLmxlbmd0aDsgICBcbiAgICAgICAgICAgIGNvbnN0IG5QbGF5ZXJzID0gcGxheWVyc0lkcy5sZW5ndGg7XG4gICAgICAgICAgICBjb25zdCBhc3NpZ25tZW50ID0gcmFuZG9tR3JvdXBpbmcobk5vdGVzLCBuUGxheWVycyk7XG4gICAgICAgICAgICBwbGF5ZXJzLmZvckVhY2gocGxheWVyU3RhdGUgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBwbElkID0gcGxheWVyU3RhdGUuZ2V0KCdpZCcpO1xuICAgICAgICAgICAgICBjb25zdCBpZElkeCA9IHBsYXllcnNJZHMuaW5kZXhPZihwbElkKTtcbiAgICAgICAgICAgICAgY29uc3QgcGxBc3NpZ25tZW50ID0gYXNzaWdubWVudFtpZElkeF07XG4gICAgICAgICAgICAgIGNvbnN0IG5vdGVzVG9TZW5kID0gW107XG4gICAgICAgICAgICAgIGZvciAobGV0IG4gb2YgcGxBc3NpZ25tZW50KSB7XG4gICAgICAgICAgICAgICAgbm90ZXNUb1NlbmQucHVzaCh1cGRhdGVzLm5vdGVzW25dKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBwbGF5ZXJTdGF0ZS5zZXQoeyBub3RlOiBub3Rlc1RvU2VuZCwgcGxheVRpbWU6IHN5bmMuZ2V0U3luY1RpbWUoKSArIDAuMSB9KTtcbiAgICAgICAgICAgIH0pOyAgXG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcihlcnIuc3RhY2spO1xuICB9XG59KSgpO1xuXG5cbmZ1bmN0aW9uIHJhbmRvbUdyb3VwaW5nKG5Hcm91cHMsIG5QbGF5ZXJzKSB7XG4gIGNvbnN0IGFzc2lnbm1lbnQgPSBBcnJheS5mcm9tKG5ldyBBcnJheShuUGxheWVycyksICgpID0+IFtdKTtcbiAgaWYgKG5Hcm91cHMgPD0gblBsYXllcnMpIHtcbiAgICBjb25zdCBwbGF5ZXJzID0gQXJyYXkuZnJvbShBcnJheShuUGxheWVycykua2V5cygpKTtcbiAgICBsZXQgZ3AgPSAwO1xuICAgIHdoaWxlIChwbGF5ZXJzLmxlbmd0aCA+IG5QbGF5ZXJzJW5Hcm91cHMpIHtcbiAgICAgIGNvbnN0IHJhbmRvbUlkeCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHBsYXllcnMubGVuZ3RoKTtcbiAgICAgIGNvbnN0IHBsYXllciA9IHBsYXllcnNbcmFuZG9tSWR4XTtcbiAgICAgIGFzc2lnbm1lbnRbcGxheWVyXS5wdXNoKGdwKTtcbiAgICAgIHBsYXllcnMuc3BsaWNlKHJhbmRvbUlkeCwgMSk7XG4gICAgICBncCA9IChncCArIDEpICUgbkdyb3VwcztcbiAgICB9XG4gICAgY29uc3QgZ3JvdXBzID0gQXJyYXkuZnJvbShBcnJheShuR3JvdXBzKS5rZXlzKCkpO1xuICAgIHdoaWxlIChwbGF5ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHJhbmRvbUlkeFBsID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogcGxheWVycy5sZW5ndGgpO1xuICAgICAgY29uc3QgcmFuZG9tSWR4R3AgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBncm91cHMubGVuZ3RoKTtcbiAgICAgIGNvbnN0IHBsYXllciA9IHBsYXllcnNbcmFuZG9tSWR4UGxdO1xuICAgICAgY29uc3QgZ3JvdXAgPSBncm91cHNbcmFuZG9tSWR4R3BdO1xuICAgICAgYXNzaWdubWVudFtwbGF5ZXJdLnB1c2goZ3JvdXApO1xuICAgICAgcGxheWVycy5zcGxpY2UocmFuZG9tSWR4UGwsIDEpO1xuICAgICAgZ3JvdXBzLnNwbGljZShyYW5kb21JZHhHcCwgMSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IGdyb3VwcyA9IEFycmF5LmZyb20oQXJyYXkobkdyb3Vwcykua2V5cygpKTtcbiAgICBsZXQgcGwgPSAwO1xuICAgIHdoaWxlIChncm91cHMubGVuZ3RoID4gbkdyb3VwcyVuUGxheWVycykge1xuICAgICAgY29uc3QgcmFuZG9tSWR4ID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogZ3JvdXBzLmxlbmd0aCk7XG4gICAgICBjb25zdCBncm91cCA9IGdyb3Vwc1tyYW5kb21JZHhdO1xuICAgICAgYXNzaWdubWVudFtwbF0ucHVzaChncm91cCk7XG4gICAgICBncm91cHMuc3BsaWNlKHJhbmRvbUlkeCwgMSk7XG4gICAgICBwbCA9IChwbCArIDEpICUgblBsYXllcnM7XG4gICAgICBjb25zb2xlLmxvZyhhc3NpZ25tZW50KTtcbiAgICB9XG4gICAgY29uc29sZS5sb2coJ3NlY29uZCBwYXJ0Jyk7XG4gICAgY29uc3QgcGxheWVycyA9IEFycmF5LmZyb20oQXJyYXkoblBsYXllcnMpLmtleXMoKSk7XG4gICAgd2hpbGUgKGdyb3Vwcy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCByYW5kb21JZHhQbCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHBsYXllcnMubGVuZ3RoKTtcbiAgICAgIGNvbnN0IHJhbmRvbUlkeEdwID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogZ3JvdXBzLmxlbmd0aCk7XG4gICAgICBjb25zdCBwbGF5ZXIgPSBwbGF5ZXJzW3JhbmRvbUlkeFBsXTtcbiAgICAgIGNvbnN0IGdyb3VwID0gZ3JvdXBzW3JhbmRvbUlkeEdwXTtcbiAgICAgIGFzc2lnbm1lbnRbcGxheWVyXS5wdXNoKGdyb3VwKTtcbiAgICAgIHBsYXllcnMuc3BsaWNlKHJhbmRvbUlkeFBsLCAxKSAgO1xuICAgICAgZ3JvdXBzLnNwbGljZShyYW5kb21JZHhHcCwgMSk7XG4gICAgICBjb25zb2xlLmxvZyhhc3NpZ25tZW50KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGFzc2lnbm1lbnQ7XG59XG5cbnByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIChyZWFzb24sIHApID0+IHtcbiAgY29uc29sZS5sb2coJz4gVW5oYW5kbGVkIFByb21pc2UgUmVqZWN0aW9uJyk7XG4gIGNvbnNvbGUubG9nKHJlYXNvbik7XG59KTtcblxuIl19