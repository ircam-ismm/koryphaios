"use strict";

require("source-map-support/register");

var _server = require("@soundworks/core/server");

var _path = _interopRequireDefault(require("path"));

var _serveStatic = _interopRequireDefault(require("serve-static"));

var _templateLiteral = _interopRequireDefault(require("template-literal"));

var _stateManagerOsc = require("@soundworks/state-manager-osc");

var _score = _interopRequireDefault(require("./schemas/score.js"));

var _player = _interopRequireDefault(require("./schemas/player.js"));

var _busControls = _interopRequireDefault(require("./schemas/busControls.js"));

var _server2 = _interopRequireDefault(require("@soundworks/plugin-platform/server"));

var _server3 = _interopRequireDefault(require("@soundworks/plugin-sync/server"));

var _server4 = _interopRequireDefault(require("@soundworks/plugin-checkin/server"));

var _PlayerExperience = _interopRequireDefault(require("./PlayerExperience.js"));

var _ControllerExperience = _interopRequireDefault(require("./ControllerExperience.js"));

var _getConfig = _interopRequireDefault(require("../utils/getConfig.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const ENV = process.env.ENV || 'default';
const config = (0, _getConfig.default)(ENV);
const server = new _server.Server(); // html template and static files (in most case, this should not be modified)

server.templateEngine = {
  compile: _templateLiteral.default
};
server.templateDirectory = _path.default.join('.build', 'server', 'tmpl');
server.router.use((0, _serveStatic.default)('public'));
server.router.use('build', (0, _serveStatic.default)(_path.default.join('.build', 'public')));
server.router.use('vendors', (0, _serveStatic.default)(_path.default.join('.vendors', 'public')));
console.log(`
--------------------------------------------------------
- launching "${config.app.name}" in "${ENV}" environment
- [pid: ${process.pid}]
--------------------------------------------------------
`); // -------------------------------------------------------------------
// register plugins
// -------------------------------------------------------------------
// server.pluginManager.register(pluginName, pluginFactory, [pluginOptions], [dependencies])

server.pluginManager.register('platform', _server2.default, {}, []);
server.pluginManager.register('sync', _server3.default, {}, []);
server.pluginManager.register('checkin', _server4.default, {}, []); // -------------------------------------------------------------------
// register schemas
// -------------------------------------------------------------------
// server.stateManager.registerSchema(name, schema);

server.stateManager.registerSchema('score', _score.default);
server.stateManager.registerSchema('player', _player.default);
server.stateManager.registerSchema('globalBusControls', _busControls.default);
server.stateManager.registerSchema('sineBusControls', _busControls.default);
server.stateManager.registerSchema('amBusControls', _busControls.default);
server.stateManager.registerSchema('fmBusControls', _busControls.default);

(async function launch() {
  try {
    await server.init(config, (clientType, config, httpRequest) => {
      return {
        clientType: clientType,
        app: {
          name: config.app.name,
          author: config.app.author
        },
        env: {
          type: config.env.type,
          websockets: config.env.websockets,
          subpath: config.env.subpath
        }
      };
    });
    const sync = server.pluginManager.get('sync');
    const score = await server.stateManager.create('score');
    const globalMasterControls = await server.stateManager.create('globalBusControls');
    const sineMasterControls = await server.stateManager.create('sineBusControls');
    const amMasterControls = await server.stateManager.create('amBusControls');
    const fmMasterControls = await server.stateManager.create('fmBusControls');
    const playerExperience = new _PlayerExperience.default(server, 'player');
    const controllerExperience = new _ControllerExperience.default(server, 'controller'); // start all the things

    await server.start();
    playerExperience.start();
    controllerExperience.start();
    const oscConfig = {
      // these are the defaults
      localAddress: '0.0.0.0',
      localPort: 57121,
      remoteAddress: '127.0.0.1',
      remotePort: 57122
    };
    const oscStateManager = new _stateManagerOsc.StateManagerOsc(server.stateManager, oscConfig);
    await oscStateManager.init(); //Observe players connections

    const players = new Set();
    const playersIds = new Array();
    server.stateManager.observe(async (schemaName, stateId, nodeId) => {
      switch (schemaName) {
        case 'player':
          const playerState = await server.stateManager.attach(schemaName, stateId);
          const plId = playerState.get('id');
          playerState.onDetach(() => {
            // clean things
            players.delete(playerState);
            playersIds.splice(playersIds.indexOf(plId), 1);
          });
          players.add(playerState);
          playersIds.push(plId);
          break;
      }
    }); //Receiving notes from Max by OSC

    score.subscribe(async updates => {
      if (updates.hasOwnProperty('notes')) {
        // console.log("note received", updates.notes.length);
        const dispatchStrategy = score.get('dispatchStrategy');

        switch (dispatchStrategy) {
          case 'sendAll':
            console.log('sendingNotes');
            players.forEach(playerState => {
              playerState.set({
                note: updates.notes,
                playTime: sync.getSyncTime() + 0.1
              });
            });
            break;

          case 'randomSpread':
            const nNotes = updates.notes.length;
            const nPlayers = playersIds.length;
            const assignment = randomGrouping(nNotes, nPlayers);
            players.forEach(playerState => {
              const plId = playerState.get('id');
              const idIdx = playersIds.indexOf(plId);
              const plAssignment = assignment[idIdx];
              const notesToSend = [];

              for (let n of plAssignment) {
                notesToSend.push(updates.notes[n]);
              }

              playerState.set({
                note: notesToSend,
                playTime: sync.getSyncTime() + 0.1
              });
            });
            break;
        }
      }
    });
  } catch (err) {
    console.error(err.stack);
  }
})();

function randomGrouping(nGroups, nPlayers) {
  const assignment = Array.from(new Array(nPlayers), () => []);

  if (nGroups <= nPlayers) {
    const players = Array.from(Array(nPlayers).keys());
    let gp = 0;

    while (players.length > nPlayers % nGroups) {
      const randomIdx = Math.floor(Math.random() * players.length);
      const player = players[randomIdx];
      assignment[player].push(gp);
      players.splice(randomIdx, 1);
      gp = (gp + 1) % nGroups;
    }

    const groups = Array.from(Array(nGroups).keys());

    while (players.length > 0) {
      const randomIdxPl = Math.floor(Math.random() * players.length);
      const randomIdxGp = Math.floor(Math.random() * groups.length);
      const player = players[randomIdxPl];
      const group = groups[randomIdxGp];
      assignment[player].push(group);
      players.splice(randomIdxPl, 1);
      groups.splice(randomIdxGp, 1);
    }
  } else {
    const groups = Array.from(Array(nGroups).keys());
    let pl = 0;

    while (groups.length > nGroups % nPlayers) {
      const randomIdx = Math.floor(Math.random() * groups.length);
      const group = groups[randomIdx];
      assignment[pl].push(group);
      groups.splice(randomIdx, 1);
      pl = (pl + 1) % nPlayers;
      console.log(assignment);
    }

    console.log('second part');
    const players = Array.from(Array(nPlayers).keys());

    while (groups.length > 0) {
      const randomIdxPl = Math.floor(Math.random() * players.length);
      const randomIdxGp = Math.floor(Math.random() * groups.length);
      const player = players[randomIdxPl];
      const group = groups[randomIdxGp];
      assignment[player].push(group);
      players.splice(randomIdxPl, 1);
      groups.splice(randomIdxGp, 1);
      console.log(assignment);
    }
  }

  return assignment;
}

process.on('unhandledRejection', (reason, p) => {
  console.log('> Unhandled Promise Rejection');
  console.log(reason);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIkVOViIsInByb2Nlc3MiLCJlbnYiLCJjb25maWciLCJzZXJ2ZXIiLCJTZXJ2ZXIiLCJ0ZW1wbGF0ZUVuZ2luZSIsImNvbXBpbGUiLCJ0ZW1wbGF0ZURpcmVjdG9yeSIsInBhdGgiLCJqb2luIiwicm91dGVyIiwidXNlIiwiY29uc29sZSIsImxvZyIsImFwcCIsIm5hbWUiLCJwaWQiLCJwbHVnaW5NYW5hZ2VyIiwicmVnaXN0ZXIiLCJwbHVnaW5QbGF0Zm9ybUZhY3RvcnkiLCJwbHVnaW5TeW5jRmFjdG9yeSIsInBsdWdpbkNoZWNraW5GYWN0b3J5Iiwic3RhdGVNYW5hZ2VyIiwicmVnaXN0ZXJTY2hlbWEiLCJzY29yZVNjaGVtYSIsInBsYXllclNjaGVtYSIsImJ1c0NvbnRyb2xzU2NoZW1hIiwibGF1bmNoIiwiaW5pdCIsImNsaWVudFR5cGUiLCJodHRwUmVxdWVzdCIsImF1dGhvciIsInR5cGUiLCJ3ZWJzb2NrZXRzIiwic3VicGF0aCIsInN5bmMiLCJnZXQiLCJzY29yZSIsImNyZWF0ZSIsImdsb2JhbE1hc3RlckNvbnRyb2xzIiwic2luZU1hc3RlckNvbnRyb2xzIiwiYW1NYXN0ZXJDb250cm9scyIsImZtTWFzdGVyQ29udHJvbHMiLCJwbGF5ZXJFeHBlcmllbmNlIiwiUGxheWVyRXhwZXJpZW5jZSIsImNvbnRyb2xsZXJFeHBlcmllbmNlIiwiQ29udHJvbGxlckV4cGVyaWVuY2UiLCJzdGFydCIsIm9zY0NvbmZpZyIsImxvY2FsQWRkcmVzcyIsImxvY2FsUG9ydCIsInJlbW90ZUFkZHJlc3MiLCJyZW1vdGVQb3J0Iiwib3NjU3RhdGVNYW5hZ2VyIiwiU3RhdGVNYW5hZ2VyT3NjIiwicGxheWVycyIsIlNldCIsInBsYXllcnNJZHMiLCJBcnJheSIsIm9ic2VydmUiLCJzY2hlbWFOYW1lIiwic3RhdGVJZCIsIm5vZGVJZCIsInBsYXllclN0YXRlIiwiYXR0YWNoIiwicGxJZCIsIm9uRGV0YWNoIiwiZGVsZXRlIiwic3BsaWNlIiwiaW5kZXhPZiIsImFkZCIsInB1c2giLCJzdWJzY3JpYmUiLCJ1cGRhdGVzIiwiaGFzT3duUHJvcGVydHkiLCJkaXNwYXRjaFN0cmF0ZWd5IiwiZm9yRWFjaCIsInNldCIsIm5vdGUiLCJub3RlcyIsInBsYXlUaW1lIiwiZ2V0U3luY1RpbWUiLCJuTm90ZXMiLCJsZW5ndGgiLCJuUGxheWVycyIsImFzc2lnbm1lbnQiLCJyYW5kb21Hcm91cGluZyIsImlkSWR4IiwicGxBc3NpZ25tZW50Iiwibm90ZXNUb1NlbmQiLCJuIiwiZXJyIiwiZXJyb3IiLCJzdGFjayIsIm5Hcm91cHMiLCJmcm9tIiwia2V5cyIsImdwIiwicmFuZG9tSWR4IiwiTWF0aCIsImZsb29yIiwicmFuZG9tIiwicGxheWVyIiwiZ3JvdXBzIiwicmFuZG9tSWR4UGwiLCJyYW5kb21JZHhHcCIsImdyb3VwIiwicGwiLCJvbiIsInJlYXNvbiIsInAiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7Ozs7QUFFQSxNQUFNQSxHQUFHLEdBQUdDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRixHQUFaLElBQW1CLFNBQS9CO0FBQ0EsTUFBTUcsTUFBTSxHQUFHLHdCQUFVSCxHQUFWLENBQWY7QUFDQSxNQUFNSSxNQUFNLEdBQUcsSUFBSUMsY0FBSixFQUFmLEMsQ0FFQTs7QUFDQUQsTUFBTSxDQUFDRSxjQUFQLEdBQXdCO0FBQUVDLEVBQUFBLE9BQU8sRUFBUEE7QUFBRixDQUF4QjtBQUNBSCxNQUFNLENBQUNJLGlCQUFQLEdBQTJCQyxjQUFLQyxJQUFMLENBQVUsUUFBVixFQUFvQixRQUFwQixFQUE4QixNQUE5QixDQUEzQjtBQUNBTixNQUFNLENBQUNPLE1BQVAsQ0FBY0MsR0FBZCxDQUFrQiwwQkFBWSxRQUFaLENBQWxCO0FBQ0FSLE1BQU0sQ0FBQ08sTUFBUCxDQUFjQyxHQUFkLENBQWtCLE9B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Z0IsQ0FBdkIsRUFBMEI7QUFDeEIsWUFBTXFCLFdBQVcsR0FBR0wsSUFBSSxDQUFDQyxLQUFMLENBQVdELElBQUksQ0FBQ0UsTUFBTCxLQUFnQjlDLE9BQU8sQ0FBQzRCLE1BQW5DLENBQXBCO0FBQ0EsWUFBTXNCLFdBQVcsR0FBR04sSUFBSSxDQUFDQyxLQUFMLENBQVdELElBQUksQ0FBQ0UsTUFBTCxLQUFnQkUsTUFBTSxDQUFDcEIsTUFBbEMsQ0FBcEI7QUFDQSxZQUFNbUIsTUFBTSxHQUFHL0MsT0FBTyxDQUFDaUQsV0FBRCxDQUF0QjtBQUNBLFlBQU1FLEtBQUssR0FBR0gsTUFBTSxDQUFDRSxXQUFELENBQXBCO0FBQ0FwQixNQUFBQSxVQUFVLENBQUNpQixNQUFELENBQVYsQ0FBbUIvQixJQUFuQixDQUF3Qm1DLEtBQXhCO0FBQ0FuRCxNQUFBQSxPQUFPLENBQUNhLE1BQVIsQ0FBZW9DLFdBQWYsRUFBNEIsQ0FBNUI7QUFDQUQsTUFBQUEsTUFBTSxDQUFDbkMsTUFBUCxDQUFjcUMsV0FBZCxFQUEyQixDQUEzQjtBQUNBN0YsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVl3RSxVQUFaO0FBQ0Q7QUFDRjs7QUFDRCxTQUFPQSxVQUFQO0FBQ0Q7O0FBRURyRixPQUFPLENBQUM0RyxFQUFSLENBQVcsb0JBQVgsRUFBaUMsQ0FBQ0MsTUFBRCxFQUFTQyxDQUFULEtBQWU7QUFDOUNsRyxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSwrQkFBWjtBQUNBRCxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWWdHLE1BQVo7QUFDRCxDQUhEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICdzb3VyY2UtbWFwLXN1cHBvcnQvcmVnaXN0ZXInO1xuaW1wb3J0IHsgU2VydmVyIH0gZnJvbSAnQHNvdW5kd29ya3MvY29yZS9zZXJ2ZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgc2VydmVTdGF0aWMgZnJvbSAnc2VydmUtc3RhdGljJztcbmltcG9ydCBjb21waWxlIGZyb20gJ3RlbXBsYXRlLWxpdGVyYWwnO1xuXG5pbXBvcnQgeyBTdGF0ZU1hbmFnZXJPc2MgfSBmcm9tICdAc291bmR3b3Jrcy9zdGF0ZS1tYW5hZ2VyLW9zYyc7XG5cbmltcG9ydCBzY29yZVNjaGVtYSBmcm9tICcuL3NjaGVtYXMvc2NvcmUuanMnO1xuaW1wb3J0IHBsYXllclNjaGVtYSBmcm9tICcuL3NjaGVtYXMvcGxheWVyLmpzJztcbmltcG9ydCBidXNDb250cm9sc1NjaGVtYSBmcm9tICcuL3NjaGVtYXMvYnVzQ29udHJvbHMuanMnO1xuXG5pbXBvcnQgcGx1Z2luUGxhdGZvcm1GYWN0b3J5IGZyb20gJ0Bzb3VuZHdvcmtzL3BsdWdpbi1wbGF0Zm9ybS9zZXJ2ZXInO1xuaW1wb3J0IHBsdWdpblN5bmNGYWN0b3J5IGZyb20gJ0Bzb3VuZHdvcmtzL3BsdWdpbi1zeW5jL3NlcnZlcic7XG5pbXBvcnQgcGx1Z2luQ2hlY2tpbkZhY3RvcnkgZnJvbSAnQHNvdW5kd29ya3MvcGx1Z2luLWNoZWNraW4vc2VydmVyJztcblxuaW1wb3J0IFBsYXllckV4cGVyaWVuY2UgZnJvbSAnLi9QbGF5ZXJFeHBlcmllbmNlLmpzJztcbmltcG9ydCBDb250cm9sbGVyRXhwZXJpZW5jZSBmcm9tICcuL0NvbnRyb2xsZXJFeHBlcmllbmNlLmpzJztcblxuaW1wb3J0IGdldENvbmZpZyBmcm9tICcuLi91dGlscy9nZXRDb25maWcuanMnO1xuaW1wb3J0IHBsYXllciBmcm9tICcuL3NjaGVtYXMvcGxheWVyLmpzJztcbmNvbnN0IEVOViA9IHByb2Nlc3MuZW52LkVOViB8fCAnZGVmYXVsdCc7XG5jb25zdCBjb25maWcgPSBnZXRDb25maWcoRU5WKTtcbmNvbnN0IHNlcnZlciA9IG5ldyBTZXJ2ZXIoKTtcblxuLy8gaHRtbCB0ZW1wbGF0ZSBhbmQgc3RhdGljIGZpbGVzIChpbiBtb3N0IGNhc2UsIHRoaXMgc2hvdWxkIG5vdCBiZSBtb2RpZmllZClcbnNlcnZlci50ZW1wbGF0ZUVuZ2luZSA9IHsgY29tcGlsZSB9O1xuc2VydmVyLnRlbXBsYXRlRGlyZWN0b3J5ID0gcGF0aC5qb2luKCcuYnVpbGQnLCAnc2VydmVyJywgJ3RtcGwnKTtcbnNlcnZlci5yb3V0ZXIudXNlKHNlcnZlU3RhdGljKCdwdWJsaWMnKSk7XG5zZXJ2ZXIucm91dGVyLnVzZSgnYnVpbGQnLCBzZXJ2ZVN0YXRpYyhwYXRoLmpvaW4oJy5idWlsZCcsICdwdWJsaWMnKSkpO1xuc2VydmVyLnJvdXRlci51c2UoJ3ZlbmRvcnMnLCBzZXJ2ZVN0YXRpYyhwYXRoLmpvaW4oJy52ZW5kb3JzJywgJ3B1YmxpYycpKSk7XG5cbmNvbnNvbGUubG9nKGBcbi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4tIGxhdW5jaGluZyBcIiR7Y29uZmlnLmFwcC5uYW1lfVwiIGluIFwiJHtFTlZ9XCIgZW52aXJvbm1lbnRcbi0gW3BpZDogJHtwcm9jZXNzLnBpZH1dXG4tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuYCk7XG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIHJlZ2lzdGVyIHBsdWdpbnNcbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIHNlcnZlci5wbHVnaW5NYW5hZ2VyLnJlZ2lzdGVyKHBsdWdpbk5hbWUsIHBsdWdpbkZhY3RvcnksIFtwbHVnaW5PcHRpb25zXSwgW2RlcGVuZGVuY2llc10pXG5zZXJ2ZXIucGx1Z2luTWFuYWdlci5yZWdpc3RlcigncGxhdGZvcm0nLCBwbHVnaW5QbGF0Zm9ybUZhY3RvcnksIHt9LCBbXSk7XG5zZXJ2ZXIucGx1Z2luTWFuYWdlci5yZWdpc3Rlcignc3luYycsIHBsdWdpblN5bmNGYWN0b3J5LCB7fSwgW10pO1xuc2VydmVyLnBsdWdpbk1hbmFnZXIucmVnaXN0ZXIoJ2NoZWNraW4nLCBwbHVnaW5DaGVja2luRmFjdG9yeSwge30sIFtdKTtcblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gcmVnaXN0ZXIgc2NoZW1hc1xuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gc2VydmVyLnN0YXRlTWFuYWdlci5yZWdpc3RlclNjaGVtYShuYW1lLCBzY2hlbWEpO1xuc2VydmVyLnN0YXRlTWFuYWdlci5yZWdpc3RlclNjaGVtYSgnc2NvcmUnLCBzY29yZVNjaGVtYSk7XG5zZXJ2ZXIuc3RhdGVNYW5hZ2VyLnJlZ2lzdGVyU2NoZW1hKCdwbGF5ZXInLCBwbGF5ZXJTY2hlbWEpO1xuc2VydmVyLnN0YXRlTWFuYWdlci5yZWdpc3RlclNjaGVtYSgnZ2xvYmFsQnVzQ29udHJvbHMnLCBidXNDb250cm9sc1NjaGVtYSk7XG5zZXJ2ZXIuc3RhdGVNYW5hZ2VyLnJlZ2lzdGVyU2NoZW1hKCdzaW5lQnVzQ29udHJvbHMnLCBidXNDb250cm9sc1NjaGVtYSk7XG5zZXJ2ZXIuc3RhdGVNYW5hZ2VyLnJlZ2lzdGVyU2NoZW1hKCdhbUJ1c0NvbnRyb2xzJywgYnVzQ29udHJvbHNTY2hlbWEpO1xuc2VydmVyLnN0YXRlTWFuYWdlci5yZWdpc3RlclNjaGVtYSgnZm1CdXNDb250cm9scycsIGJ1c0NvbnRyb2xzU2NoZW1hKTtcblxuXG4oYXN5bmMgZnVuY3Rpb24gbGF1bmNoKCkge1xuICB0cnkge1xuICAgIGF3YWl0IHNlcnZlci5pbml0KGNvbmZpZywgKGNsaWVudFR5cGUsIGNvbmZpZywgaHR0cFJlcXVlc3QpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGNsaWVudFR5cGU6IGNsaWVudFR5cGUsXG4gICAgICAgIGFwcDoge1xuICAgICAgICAgIG5hbWU6IGNvbmZpZy5hcHAubmFtZSxcbiAgICAgICAgICBhdXRob3I6IGNvbmZpZy5hcHAuYXV0aG9yLFxuICAgICAgICB9LFxuICAgICAgICBlbnY6IHtcbiAgICAgICAgICB0eXBlOiBjb25maWcuZW52LnR5cGUsXG4gICAgICAgICAgd2Vic29ja2V0czogY29uZmlnLmVudi53ZWJzb2NrZXRzLFxuICAgICAgICAgIHN1YnBhdGg6IGNvbmZpZy5lbnYuc3VicGF0aCxcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHN5bmMgPSBzZXJ2ZXIucGx1Z2luTWFuYWdlci5nZXQoJ3N5bmMnKTtcblxuICAgIGNvbnN0IHNjb3JlID0gYXdhaXQgc2VydmVyLnN0YXRlTWFuYWdlci5jcmVhdGUoJ3Njb3JlJyk7XG4gICAgY29uc3QgZ2xvYmFsTWFzdGVyQ29udHJvbHMgPSBhd2FpdCBzZXJ2ZXIuc3RhdGVNYW5hZ2VyLmNyZWF0ZSgnZ2xvYmFsQnVzQ29udHJvbHMnKTtcbiAgICBjb25zdCBzaW5lTWFzdGVyQ29udHJvbHMgPSBhd2FpdCBzZXJ2ZXIuc3RhdGVNYW5hZ2VyLmNyZWF0ZSgnc2luZUJ1c0NvbnRyb2xzJyk7XG4gICAgY29uc3QgYW1NYXN0ZXJDb250cm9scyA9IGF3YWl0IHNlcnZlci5zdGF0ZU1hbmFnZXIuY3JlYXRlKCdhbUJ1c0NvbnRyb2xzJyk7XG4gICAgY29uc3QgZm1NYXN0ZXJDb250cm9scyA9IGF3YWl0IHNlcnZlci5zdGF0ZU1hbmFnZXIuY3JlYXRlKCdmbUJ1c0NvbnRyb2xzJyk7XG5cbiAgICBjb25zdCBwbGF5ZXJFeHBlcmllbmNlID0gbmV3IFBsYXllckV4cGVyaWVuY2Uoc2VydmVyLCAncGxheWVyJyk7XG4gICAgY29uc3QgY29udHJvbGxlckV4cGVyaWVuY2UgPSBuZXcgQ29udHJvbGxlckV4cGVyaWVuY2Uoc2VydmVyLCAnY29udHJvbGxlcicpO1xuXG4gICAgLy8gc3RhcnQgYWxsIHRoZSB0aGluZ3NcbiAgICBhd2FpdCBzZXJ2ZXIuc3RhcnQoKTtcbiAgICBwbGF5ZXJFeHBlcmllbmNlLnN0YXJ0KCk7XG4gICAgY29udHJvbGxlckV4cGVyaWVuY2Uuc3RhcnQoKTtcblxuICAgIGNvbnN0IG9zY0NvbmZpZyA9IHsgLy8gdGhlc2UgYXJlIHRoZSBkZWZhdWx0c1xuICAgICAgbG9jYWxBZGRyZXNzOiAnMC4wLjAuMCcsXG4gICAgICBsb2NhbFBvcnQ6IDU3MTIxLFxuICAgICAgcmVtb3RlQWRkcmVzczogJzEyNy4wLjAuMScsXG4gICAgICByZW1vdGVQb3J0OiA1NzEyMixcbiAgICB9O1xuICAgIFxuICAgIGNvbnN0IG9zY1N0YXRlTWFuYWdlciA9IG5ldyBTdGF0ZU1hbmFnZXJPc2Moc2VydmVyLnN0YXRlTWFuYWdlciwgb3NjQ29uZmlnKTtcbiAgICBhd2FpdCBvc2NTdGF0ZU1hbmFnZXIuaW5pdCgpO1xuXG4gICAgLy9PYnNlcnZlIHBsYXllcnMgY29ubmVjdGlvbnNcbiAgICBjb25zdCBwbGF5ZXJzID0gbmV3IFNldCgpO1xuICAgIGNvbnN0IHBsYXllcnNJZHMgPSBuZXcgQXJyYXkoKTtcblxuICAgIHNlcnZlci5zdGF0ZU1hbmFnZXIub2JzZXJ2ZShhc3luYyAoc2NoZW1hTmFtZSwgc3RhdGVJZCwgbm9kZUlkKSA9PiB7XG4gICAgICBzd2l0Y2ggKHNjaGVtYU5hbWUpIHtcbiAgICAgICAgY2FzZSAncGxheWVyJzpcbiAgICAgICAgICBjb25zdCBwbGF5ZXJTdGF0ZSA9IGF3YWl0IHNlcnZlci5zdGF0ZU1hbmFnZXIuYXR0YWNoKHNjaGVtYU5hbWUsIHN0YXRlSWQpO1xuICAgICAgICAgIGNvbnN0IHBsSWQgPSBwbGF5ZXJTdGF0ZS5nZXQoJ2lkJyk7XG4gICAgICAgICAgcGxheWVyU3RhdGUub25EZXRhY2goKCkgPT4ge1xuICAgICAgICAgICAgLy8gY2xlYW4gdGhpbmdzXG4gICAgICAgICAgICBwbGF5ZXJzLmRlbGV0ZShwbGF5ZXJTdGF0ZSk7XG4gICAgICAgICAgICBwbGF5ZXJzSWRzLnNwbGljZShwbGF5ZXJzSWRzLmluZGV4T2YocGxJZCksIDEpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHBsYXllcnMuYWRkKHBsYXllclN0YXRlKTtcbiAgICAgICAgICBwbGF5ZXJzSWRzLnB1c2gocGxJZCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfSk7XG5cblxuICAgIC8vUmVjZWl2aW5nIG5vdGVzIGZyb20gTWF4IGJ5IE9TQ1xuICAgIHNjb3JlLnN1YnNjcmliZShhc3luYyB1cGRhdGVzID0+IHtcbiAgICAgIGlmICh1cGRhdGVzLmhhc093blByb3BlcnR5KCdub3RlcycpKSB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwibm90ZSByZWNlaXZlZFwiLCB1cGRhdGVzLm5vdGVzLmxlbmd0aCk7XG4gICAgICAgIGNvbnN0IGRpc3BhdGNoU3RyYXRlZ3kgPSBzY29yZS5nZXQoJ2Rpc3BhdGNoU3RyYXRlZ3knKTtcbiAgICAgICAgXG4gICAgICAgIHN3aXRjaCAoZGlzcGF0Y2hTdHJhdGVneSkge1xuICAgICAgICAgIGNhc2UgJ3NlbmRBbGwnOlxuICAgICAgICAgICAgY29uc29sZS5sb2coJ3NlbmRpbmdOb3RlcycpO1xuICAgICAgICAgICAgcGxheWVycy5mb3JFYWNoKHBsYXllclN0YXRlID0+IHtcbiAgICAgICAgICAgICAgcGxheWVyU3RhdGUuc2V0KHsgbm90ZTogdXBkYXRlcy5ub3RlcywgcGxheVRpbWU6IHN5bmMuZ2V0U3luY1RpbWUoKSArIDAuMSB9KTtcbiAgICAgICAgICAgIH0pOyAgICBcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ3JhbmRvbVNwcmVhZCc6XG4gICAgICAgICAgICBjb25zdCBuTm90ZXMgPSB1cGRhdGVzLm5vdGVzLmxlbmd0aDsgICBcbiAgICAgICAgICAgIGNvbnN0IG5QbGF5ZXJzID0gcGxheWVyc0lkcy5sZW5ndGg7XG4gICAgICAgICAgICBjb25zdCBhc3NpZ25tZW50ID0gcmFuZG9tR3JvdXBpbmcobk5vdGVzLCBuUGxheWVycyk7XG4gICAgICAgICAgICBwbGF5ZXJzLmZvckVhY2gocGxheWVyU3RhdGUgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBwbElkID0gcGxheWVyU3RhdGUuZ2V0KCdpZCcpO1xuICAgICAgICAgICAgICBjb25zdCBpZElkeCA9IHBsYXllcnNJZHMuaW5kZXhPZihwbElkKTtcbiAgICAgICAgICAgICAgY29uc3QgcGxBc3NpZ25tZW50ID0gYXNzaWdubWVudFtpZElkeF07XG4gICAgICAgICAgICAgIGNvbnN0IG5vdGVzVG9TZW5kID0gW107XG4gICAgICAgICAgICAgIGZvciAobGV0IG4gb2YgcGxBc3NpZ25tZW50KSB7XG4gICAgICAgICAgICAgICAgbm90ZXNUb1NlbmQucHVzaCh1cGRhdGVzLm5vdGVzW25dKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBwbGF5ZXJTdGF0ZS5zZXQoeyBub3RlOiBub3Rlc1RvU2VuZCwgcGxheVRpbWU6IHN5bmMuZ2V0U3luY1RpbWUoKSArIDAuMSB9KTtcbiAgICAgICAgICAgIH0pOyAgXG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcihlcnIuc3RhY2spO1xuICB9XG59KSgpO1xuXG5cbmZ1bmN0aW9uIHJhbmRvbUdyb3VwaW5nKG5Hcm91cHMsIG5QbGF5ZXJzKSB7XG4gIGNvbnN0IGFzc2lnbm1lbnQgPSBBcnJheS5mcm9tKG5ldyBBcnJheShuUGxheWVycyksICgpID0+IFtdKTtcbiAgaWYgKG5Hcm91cHMgPD0gblBsYXllcnMpIHtcbiAgICBjb25zdCBwbGF5ZXJzID0gQXJyYXkuZnJvbShBcnJheShuUGxheWVycykua2V5cygpKTtcbiAgICBsZXQgZ3AgPSAwO1xuICAgIHdoaWxlIChwbGF5ZXJzLmxlbmd0aCA+IG5QbGF5ZXJzJW5Hcm91cHMpIHtcbiAgICAgIGNvbnN0IHJhbmRvbUlkeCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHBsYXllcnMubGVuZ3RoKTtcbiAgICAgIGNvbnN0IHBsYXllciA9IHBsYXllcnNbcmFuZG9tSWR4XTtcbiAgICAgIGFzc2lnbm1lbnRbcGxheWVyXS5wdXNoKGdwKTtcbiAgICAgIHBsYXllcnMuc3BsaWNlKHJhbmRvbUlkeCwgMSk7XG4gICAgICBncCA9IChncCArIDEpICUgbkdyb3VwcztcbiAgICB9XG4gICAgY29uc3QgZ3JvdXBzID0gQXJyYXkuZnJvbShBcnJheShuR3JvdXBzKS5rZXlzKCkpO1xuICAgIHdoaWxlIChwbGF5ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHJhbmRvbUlkeFBsID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogcGxheWVycy5sZW5ndGgpO1xuICAgICAgY29uc3QgcmFuZG9tSWR4R3AgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBncm91cHMubGVuZ3RoKTtcbiAgICAgIGNvbnN0IHBsYXllciA9IHBsYXllcnNbcmFuZG9tSWR4UGxdO1xuICAgICAgY29uc3QgZ3JvdXAgPSBncm91cHNbcmFuZG9tSWR4R3BdO1xuICAgICAgYXNzaWdubWVudFtwbGF5ZXJdLnB1c2goZ3JvdXApO1xuICAgICAgcGxheWVycy5zcGxpY2UocmFuZG9tSWR4UGwsIDEpO1xuICAgICAgZ3JvdXBzLnNwbGljZShyYW5kb21JZHhHcCwgMSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IGdyb3VwcyA9IEFycmF5LmZyb20oQXJyYXkobkdyb3Vwcykua2V5cygpKTtcbiAgICBsZXQgcGwgPSAwO1xuICAgIHdoaWxlIChncm91cHMubGVuZ3RoID4gbkdyb3VwcyVuUGxheWVycykge1xuICAgICAgY29uc3QgcmFuZG9tSWR4ID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogZ3JvdXBzLmxlbmd0aCk7XG4gICAgICBjb25zdCBncm91cCA9IGdyb3Vwc1tyYW5kb21JZHhdO1xuICAgICAgYXNzaWdubWVudFtwbF0ucHVzaChncm91cCk7XG4gICAgICBncm91cHMuc3BsaWNlKHJhbmRvbUlkeCwgMSk7XG4gICAgICBwbCA9IChwbCArIDEpICUgblBsYXllcnM7XG4gICAgICBjb25zb2xlLmxvZyhhc3NpZ25tZW50KTtcbiAgICB9XG4gICAgY29uc29sZS5sb2coJ3NlY29uZCBwYXJ0Jyk7XG4gICAgY29uc3QgcGxheWVycyA9IEFycmF5LmZyb20oQXJyYXkoblBsYXllcnMpLmtleXMoKSk7XG4gICAgd2hpbGUgKGdyb3Vwcy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCByYW5kb21JZHhQbCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHBsYXllcnMubGVuZ3RoKTtcbiAgICAgIGNvbnN0IHJhbmRvbUlkeEdwID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogZ3JvdXBzLmxlbmd0aCk7XG4gICAgICBjb25zdCBwbGF5ZXIgPSBwbGF5ZXJzW3JhbmRvbUlkeFBsXTtcbiAgICAgIGNvbnN0IGdyb3VwID0gZ3JvdXBzW3JhbmRvbUlkeEdwXTtcbiAgICAgIGFzc2lnbm1lbnRbcGxheWVyXS5wdXNoKGdyb3VwKTtcbiAgICAgIHBsYXllcnMuc3BsaWNlKHJhbmRvbUlkeFBsLCAxKSAgO1xuICAgICAgZ3JvdXBzLnNwbGljZShyYW5kb21JZHhHcCwgMSk7XG4gICAgICBjb25zb2xlLmxvZyhhc3NpZ25tZW50KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGFzc2lnbm1lbnQ7XG59XG5cbnByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIChyZWFzb24sIHApID0+IHtcbiAgY29uc29sZS5sb2coJz4gVW5oYW5kbGVkIFByb21pc2UgUmVqZWN0aW9uJyk7XG4gIGNvbnNvbGUubG9nKHJlYXNvbik7XG59KTtcblxuIl19